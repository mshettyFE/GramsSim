# GramsG4

If you want a formatted (or easier-to-read) version of this file, scroll to the bottom of `GramsSim/README.md` for instructions. If you're reading this on github, then it's already formatted. 

- [GramsG4](#gramsg4)
  * [Introduction](#introduction)
  * [Running GramsG4](#running-gramsg4)
    + [Controlling the particle source](#controlling-the-particle-source)
    + [Visualization](#visualization)
    + [Events from an external generator](#events-from-an-external-generator)
      - [Notes](#notes)
    + [Program outputs](#program-outputs)
    + [Generating large numbers of events](#generating-large-numbers-of-events)
  * [Physics lists and how to extend them](#physics-lists-and-how-to-extend-them)
    + [Using the available physics lists](#using-the-available-physics-lists)
    + [Custom physics lists](#custom-physics-lists)
  * [References](#references)

<small><i><a href='http://ecotrust-canada.github.io/markdown-toc/'>Table of contents generated with markdown-toc</a></i></small>

## Introduction

**GramsG4** is a simulation of particle transport in the [GRAMS](https://express.northeastern.edu/grams/) detector. It is based on [Geant4](http://geant4.web.cern.ch/), a general-purpose particle-physics detector simulation.

## Running GramsG4

Before running GramsG4 (or any of the GramsSim programs), please read
[`GramsSim/README.md`](../README.md) for how to set up a GramsSim build/work
area. When you want to change program options, see
[`GramsSim/util/README.md`](../util/README.md).

To run the simulation:

    # After succesfully making the executable "gramsg4", you can run it
    # in the build directory:
    ./gramsg4

If no one has changed the defaults (see *Program Options* below), the Geant4 simulation
will generate 1000 1 *MeV* gammas. If you'd like to see an interactive
display:

    ./gramsg4 --ui
    
### Controlling the particle source

GramsG4 uses the [Geant4 general particle source](http://geant4-userdoc.web.cern.ch/geant4-userdoc/UsersGuides/ForApplicationDeveloper/html/GettingStarted/generalParticleSource.html) (or "gps") to generate primary particles. The gps commands
can only be executed from Geant4 macro files. You can find examples in the `GramsSim/mac` directory. 
See [`GramsSim/mac/README.md`](../mac/README.md) for a description of the examples. 

To use a particular Geant4 macro file, e.g.,  `mac/run.mac`:
```
    ./gramsg4 -m mac/run.mac    
```

The interactive display uses a different option to specify its macro file, to make it easy to
switch between batch-style tests and interactive displays. For example, to use the interactive
display defined in mac/vis.mac:
```
    ./gramsg4 --ui --uimacrofile mac/vis.mac
``` 

If you want to change the primary particle type, energy, distribution, or number of events generated by the simulation, edit a 
G4 macro file. For example, if you want to generate 2000 events, you can copy an existing
file and edit it:
```
    cp mac/batch.mac my_test.mac
    emacs my_test.mac
    # edit '/run/beamOn 1000' to '/run/beamOn 2000'
    ./gramsg4 --macrofile my_test.mac
```

Of particular interest is the file `mac/sky.mac`, which shows how to generate an energy spectrum from a user-supplied histogram with positions given uniformly by a sphere surrounding the detector. 

For more on the gps commands, see the [References](#references) section near the end of this document. 

### Visualization

See `GramsSim/mac/README.md` for a description of the visualization examples in the `GramsSim/mac` directory.

### Events from an external generator

The GPS commands may not be sufficient. For example, you may want to generate the primary particles from an initial nuclear interaction (*n-<span style="text-decoration:overline">n</span>*
oscillations are one such case), a shower of particles from a cosmic-ray simulation, or the output of GramsSky
(see [`GramsSim/GramsSky/README.md`](../GramsSky/README.md)). 

GramsG4 can read files of events in [HepMC3](https://gitlab.cern.ch/hepmc/HepMC3) format. A typical command to run the simulation with an input file would be:

    ./gramsg4 --macrofile mac/hepmc3.mac --inputgen scripts/example.hepmc3

Note that HepMC3 can also read files in various formats. The format of the file is assumed to match the file's extension (the part after the final period ".") as follows:

<table>
<tr><th>Extension</th><th>Format</th></tr>
<tr><td>.hepmc3</td><td>HepMC3 ASCII</td></tr>
<tr><td>.hepmc2</td><td>HepMC2 ASCII</td></tr>
<tr><td>.hpe</td><td><a href="https://cdcvs.fnal.gov/redmine/projects/minos-sim/wiki/HEPEVT_files">HEPEVT</a> (ASCII)</td></tr>
<tr><td>.lhef</td><td><a href="http://home.thep.lu.se/~leif/LHEF/LHEF_8h_source.html">Les Houches Event File</a></td></tr>
<tr><td>.root</td><td>HepMC3 ROOT</td></tr>
<tr><td>.treeroot</td><td>HepMC3 ROOT TTree</td></tr>
</table>

If you want to write HepMC3 files, there are a couple of simple examples in the `scripts/` directory. More detailed examples can be found in the `examples/` directory within the HepMC3 distribution. 

#### Notes

   - The number of events generated by GramsG4 is determined by the `/run/beamOn` command in the input `.mac` file; there's an example in `mac/hepmc3.mac`. If the number of events in the `beamOn` command exceeds the number of events in the HepMC3 file, GramsG4 will "rewind" the file and read it from the beginning. 
   
   - When creating the event->vertex->particles structure for an HepMC3 `GenEvent` object, there must be at least one incoming particle to the vertex even though GramsG4 will only process the outgoing particles. The program `GramsSim/script/hepmc3-grams-example.cc` demonstrates a work-around. 
   
   - Of the above formats, `.hepmc3` files are closest to human-readable.


### Program outputs

These are likely to change rapidly as the software improves. This is the state of program outputs as of 17-Mar-2021.

The `gramsg4` program produces only one ROOT output file containing multiple ntuples. The default name of the output file is `gramsg4.root`. This can be changed via a job option (see *Program Options* below); e.g.,

    ./gramsg4 -o myStudy

will write the output to `myStudy.root`.

There are several ntuples in the ROOT file: 
   - `LArHits`, which contains energy deposits in the LAr (both ionization energy and optical photons);
   - `ScintillatorHits`, which contains energy deposits in the inner and outer scintillators in the detector;
   - `TrackInfo`, which contains 'truth' information for all the tracks in the simulation;
   - `Options`, which includes the parsed options for the job (options XML file with the user overrides).
   
To understand the structure of the ntuples, either view the contents using ROOT, or look in [`$GGDIR/GramsSim/GramsG4/src/GramsG4WriteNtuplesAction.cc`][src/GramsG4WriteNtuplesAction.cc].

For information about what the term "Identifier" means, see [`grams.gdml`](grams.gdml). (It's explained there, instead of in this documentation, because it's in `grams.gdml` that Identifiers are defined and assigned.)

If you don't know how to browse an ROOT ntuple, I suggest this [ROOT tutorial](https://www.nevis.columbia.edu/~seligman/root-class/).

*Note:* The G4Track IDs will be in the order that Geant4 processes them, which is *not* in ascending numeric order (even if you don't run with multiple threads; see below). Also note that it's possible for an event to leave no energy deposits in an active TPC volume, so there may be information in `TrackInfo` with no corresponding information in `LArHits`. 

If you're looking for a place to start in accessing the ntuples for analysis, look at the examples in the `scripts` directory which was copied to your build/work directory. 
    
### Generating large numbers of events

Some things to consider:

   - You can speed up the simulation considerably by turning on multi-threaded running. To do this,
   supply the number of threads to use via the `-t` or `--nthreads` option; e.g.,
   
      `./gramsg4 --nthreads 4`
      
       will run with 4 simultaneous threads. The potential disadvantage of this is that the information in the output
       ntuples will *not* be in ascending order. 
       
   - If you are running multiple jobs to generate events, by default they'll all run with the same random number seed;
   i.e., in the options XML file there is a parameter `rngseed` which is set to -1 by default. To generate a different set
   of events for each job, you will want to vary the seed for each job. 
   
      For example, if the job has a unique process ID in the variable `${Process}`, then you probably want something like this:
      
      `./gramsg4 --rngseed ${Process}`

## Physics lists and how to extend them

If you looked at `options.xml` you saw an intriguing option (the list may not be `FTFP_BERT`):


```
    <option name="physicslist" short= "p" value="FTFP_BERT" type="string" desc="physics list"/>
```

The program uses the extensible physics-list factory described in a
Geant4 example; at Nevis, this example can be found at
`$G4INSTALL/share/*/examples/extended/physicslists/extensibleFactory`.
If you run the program using the "&#x2011;&#x2011;showphysicslists" option (or simply
"&#x2011;l" [that's "dash&#x2011;ell", not "dash&#x2011;one"]), you'll see all the available physics
lists and modifiers. 

Here's the first part of the output when I run this command with Geant4 10.5.1:
```
./gramsg4 -l
    
Available physics lists:
Base G4VModularPhysicsLists in G4PhysListRegistry are:
 [  0]  "FTFP_BERT"
 [  1]  "FTFP_BERT_ATL"
 [  2]  "FTFP_BERT_HP"
 [  3]  "FTFP_BERT_TRV"
 [  4]  "FTFP_INCLXX"
 [  5]  "FTFP_INCLXX_HP"
 [  6]  "FTFQGSP_BERT"
 [  7]  "FTF_BIC"
 [  8]  "G4GenericPhysicsList"
 [  9]  "LBE"
 [ 10]  "MySpecialPhysList"
```

and so on.

### Using the available physics lists

If you've gotten this far, you're probably overwhelmed with the choices.
Your first question is probably "What does each of them do?"
Unfortunately, at the time of this writing (May-2020) there isn't one
single source that provides an answer. Here are some links to get you
started:

* [Short Guide to Choosing Your Physics List](https://indico.cern.ch/event/776050/contributions/3241826/attachments/1789270/2914266/ChoosingPhysLists.pdf) (PDF presentation)
* [G4 Physics List Guide](http://geant4-userdoc.web.cern.ch/geant4-userdoc/UsersGuides/PhysicsListGuide/BackupVersions/V10.5-2.0/html/physicslistguide.html) (incomplete)

If you're just starting out, the Geant4 collaboration's recommendations for initial tests is `FTFP_BERT`. 
Here it is set explicitly on the command line:


    ./gramsg4 --physicslist FTFP_BERT

If your research indicates you should try one of the other base physics lists, e.g., `QBBC`


    ./gramsg4 --physicslist QBBC

Perhaps you decide that you want to try one of the alternative models for EM physics, listed under *Replacement mappings* in the full output of &#x2011;&#x2011;showphysicslists:

    ./gramsg4 --physicslist QBBC_EMV

If you need to include one or more of the additional constructors, e.g., `G4OpticalPhysics`:

    ./gramsg4 --physicslist QBBC_EMV+G4OpticalPhysics

### Custom physics lists

If you look at the above list carefully, you saw `MySpecialPhysList`
among the available lists. This comes from the Geant4 extensibleFactory
example, and can serve as a basis for your own fine-tuning of a physics
list. To understand what you need to do to add your own custom list, see
these files:

```
GramsSim/GramsG4/gramsg4.cc
GramsSim/GramsG4/include/MySpecialPhysList.hh
GramsSim/GramsG4/include/MySpecialPhysList.icc
```

These last two files are unaltered from the Geant4 extensibleFactory
example. As it stands, they just implement the QBBC physics list without
any changes.

To get some idea of what and how you can change in your own custom
physics list, see the Geant4 examples. To find relevant files, at Nevis
I use the UNIX `find` command:

    find $G4INSTALL/share/*/examples/ -name \*PhysicsList\*

This will show you many places to get started!

## References

Toolkits:
   - [Geant4 Manual](http://geant4.web.cern.ch/geant4/UserDocumentation/UsersGuides/ForApplicationDeveloper/html/)
   - [ROOT Tutorial](https://www.nevis.columbia.edu/~seligman/root-class/)

GDML detector geometry description
   - [GDML manual](http://lcgapp.cern.ch/project/simu/framework/GDML/doc/GDMLmanual.pdf)
   - [Geant4 Applications Guide](http://geant4-userdoc.web.cern.ch/geant4-userdoc/UsersGuides/ForApplicationDeveloper/html/), especially the [geometry section](http://geant4-userdoc.web.cern.ch/geant4-userdoc/UsersGuides/ForApplicationDeveloper/html/Detector/Geometry/geometry.html) which explains the difference between solids, logical volumes, and physical volumes. 

Geant4 General Particle Source:
   - [Documentation](http://geant4-userdoc.web.cern.ch/geant4-userdoc/UsersGuides/ForApplicationDeveloper/html/GettingStarted/generalParticleSource.html)
   - [Examples](http://hurel.hanyang.ac.kr/Geant4/Geant4_GPS/reat.space.qinetiq.com/gps/examples/examples.html)
   - [Concepts](https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&cad=rja&uact=8&ved=2ahUKEwiY15u9wP3qAhXFJt8KHQk7C1gQFjADegQIBRAB&url=https%3A%2F%2Findico.in2p3.fr%2Fevent%2F443%2Fcontributions%2F30793%2Fattachments%2F24858%2F30632%2FGSantin_Geant4_Annecy2008_GPS_v11.ppt&usg=AOvVaw0yJS5FTzA2-btA1ag7XCX9) (Microsoft Powerpoint document)
